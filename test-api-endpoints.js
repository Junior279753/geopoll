const http = require('http');

// Configuration
const BASE_URL = 'http://localhost:3001';
const TEST_USER = {
    email: `test.${Date.now()}@geopoll.test`,
    password: 'Test123!',
    firstName: 'Test',
    lastName: 'User',
    phone: '+225123456789',
    country: 'C√¥te d\'Ivoire',
    countryCode: 'CI',
    profession: 'employe'  // Profession valide selon la validation
};

const ADMIN_USER = {
    email: 'admin@geopoll.ci',
    password: 'admin123'
};

let userToken = null;
let adminToken = null;
let testUserId = null;

console.log('üß™ === TEST AUTOMATIS√â DES APIS GEOPOLL ===\n');

// Fonction utilitaire pour faire des requ√™tes HTTP
function makeRequest(method, path, data = null, token = null) {
    return new Promise((resolve, reject) => {
        const url = new URL(path, BASE_URL);
        
        const options = {
            hostname: url.hostname,
            port: url.port,
            path: url.pathname + url.search,
            method: method,
            headers: {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            }
        };

        const req = http.request(options, (res) => {
            let body = '';
            res.on('data', (chunk) => {
                body += chunk;
            });
            res.on('end', () => {
                try {
                    const jsonBody = body ? JSON.parse(body) : {};
                    resolve({
                        statusCode: res.statusCode,
                        headers: res.headers,
                        body: jsonBody
                    });
                } catch (error) {
                    resolve({
                        statusCode: res.statusCode,
                        headers: res.headers,
                        body: body
                    });
                }
            });
        });

        req.on('error', (error) => {
            reject(error);
        });

        if (data) {
            req.write(JSON.stringify(data));
        }

        req.end();
    });
}

// Test 1: Inscription utilisateur
async function testUserRegistration() {
    console.log('1Ô∏è‚É£ Test inscription utilisateur...');
    
    try {
        const response = await makeRequest('POST', '/api/auth/register', TEST_USER);
        
        if (response.statusCode === 201) {
            console.log('‚úÖ Inscription r√©ussie');
            console.log(`   Email: ${TEST_USER.email}`);
            testUserId = response.body.user?.id;
            return true;
        } else {
            console.log('‚ùå √âchec inscription:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur inscription:', error.message);
        return false;
    }
}

// Test 2: Connexion utilisateur
async function testUserLogin() {
    console.log('\n2Ô∏è‚É£ Test connexion utilisateur...');
    
    try {
        const response = await makeRequest('POST', '/api/auth/login', {
            email: TEST_USER.email,
            password: TEST_USER.password
        });
        
        if (response.statusCode === 200) {
            console.log('‚úÖ Connexion utilisateur r√©ussie');
            userToken = response.body.token;
            console.log(`   Token re√ßu: ${userToken ? 'Oui' : 'Non'}`);
            console.log(`   Statut approbation: ${response.body.user.adminApproved ? 'Approuv√©' : 'En attente'}`);
            return true;
        } else {
            console.log('‚ùå √âchec connexion utilisateur:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur connexion utilisateur:', error.message);
        return false;
    }
}

// Test 3: Acc√®s au profil utilisateur
async function testUserProfile() {
    console.log('\n3Ô∏è‚É£ Test acc√®s profil utilisateur...');
    
    try {
        const response = await makeRequest('GET', '/api/auth/profile', null, userToken);
        
        if (response.statusCode === 200) {
            console.log('‚úÖ Acc√®s profil r√©ussi');
            console.log(`   Nom: ${response.body.user.firstName} ${response.body.user.lastName}`);
            console.log(`   Email: ${response.body.user.email}`);
            return true;
        } else {
            console.log('‚ùå √âchec acc√®s profil:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur acc√®s profil:', error.message);
        return false;
    }
}

// Test 4: Connexion admin
async function testAdminLogin() {
    console.log('\n4Ô∏è‚É£ Test connexion admin...');
    
    try {
        const response = await makeRequest('POST', '/api/auth/login', ADMIN_USER);
        
        if (response.statusCode === 200) {
            console.log('‚úÖ Connexion admin r√©ussie');
            adminToken = response.body.token;
            console.log(`   Admin: ${response.body.user.isAdmin ? 'Oui' : 'Non'}`);
            console.log(`   Email: ${response.body.user.email}`);
            return true;
        } else {
            console.log('‚ùå √âchec connexion admin:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur connexion admin:', error.message);
        return false;
    }
}

// Test 5: Acc√®s aux statistiques admin
async function testAdminStats() {
    console.log('\n5Ô∏è‚É£ Test statistiques admin...');
    
    try {
        const response = await makeRequest('GET', '/api/admin/stats', null, adminToken);
        
        if (response.statusCode === 200) {
            console.log('‚úÖ Acc√®s statistiques r√©ussi');
            console.log(`   Utilisateurs totaux: ${response.body.users?.total_users || 'N/A'}`);
            console.log(`   Utilisateurs actifs: ${response.body.users?.active_users || 'N/A'}`);
            return true;
        } else {
            console.log('‚ùå √âchec acc√®s statistiques:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur acc√®s statistiques:', error.message);
        return false;
    }
}

// Test 6: Liste des utilisateurs admin
async function testAdminUsers() {
    console.log('\n6Ô∏è‚É£ Test liste utilisateurs admin...');
    
    try {
        const response = await makeRequest('GET', '/api/admin/users', null, adminToken);
        
        if (response.statusCode === 200) {
            console.log('‚úÖ Acc√®s liste utilisateurs r√©ussi');
            console.log(`   Nombre d'utilisateurs: ${response.body.users?.length || 0}`);
            
            // Chercher notre utilisateur de test
            const testUser = response.body.users?.find(u => u.email === TEST_USER.email);
            if (testUser) {
                console.log(`   Utilisateur de test trouv√©: ${testUser.first_name} ${testUser.last_name}`);
                console.log(`   Statut: ${testUser.admin_approved ? 'Approuv√©' : 'En attente'}`);
                testUserId = testUser.id;
            }
            return true;
        } else {
            console.log('‚ùå √âchec acc√®s liste utilisateurs:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur acc√®s liste utilisateurs:', error.message);
        return false;
    }
}

// Test 7: Approbation utilisateur
async function testUserApproval() {
    console.log('\n7Ô∏è‚É£ Test approbation utilisateur...');
    
    if (!testUserId) {
        console.log('‚ùå ID utilisateur de test non trouv√©');
        return false;
    }
    
    try {
        const response = await makeRequest('POST', `/api/admin/users/${testUserId}/approve`, null, adminToken);
        
        if (response.statusCode === 200) {
            console.log('‚úÖ Approbation utilisateur r√©ussie');
            console.log(`   Message: ${response.body.message}`);
            return true;
        } else {
            console.log('‚ùå √âchec approbation:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur approbation:', error.message);
        return false;
    }
}

// Test 8: Reconnexion apr√®s approbation
async function testUserReloginAfterApproval() {
    console.log('\n8Ô∏è‚É£ Test reconnexion apr√®s approbation...');

    try {
        const response = await makeRequest('POST', '/api/auth/login', {
            email: TEST_USER.email,
            password: TEST_USER.password
        });

        if (response.statusCode === 200) {
            console.log('‚úÖ Reconnexion apr√®s approbation r√©ussie');
            userToken = response.body.token;
            console.log(`   Statut approbation: ${response.body.user.adminApproved ? 'Approuv√©' : 'En attente'}`);
            return response.body.user.adminApproved;
        } else {
            console.log('‚ùå √âchec reconnexion:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur reconnexion:', error.message);
        return false;
    }
}

// Test 9: Acc√®s aux th√®mes de sondage
async function testSurveyThemes() {
    console.log('\n9Ô∏è‚É£ Test acc√®s th√®mes de sondage...');

    try {
        const response = await makeRequest('GET', '/api/surveys/themes', null, userToken);

        if (response.statusCode === 200) {
            console.log('‚úÖ Acc√®s th√®mes r√©ussi');
            console.log(`   Nombre de th√®mes: ${response.body.length}`);
            if (response.body.length > 0) {
                console.log(`   Premier th√®me: ${response.body[0].name}`);
                console.log(`   Peut commencer: ${response.body[0].canStart ? 'Oui' : 'Non'}`);
            }
            return true;
        } else {
            console.log('‚ùå √âchec acc√®s th√®mes:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur acc√®s th√®mes:', error.message);
        return false;
    }
}

// Test 10: D√©marrage d'un sondage
async function testStartSurvey() {
    console.log('\nüîü Test d√©marrage sondage...');

    try {
        const response = await makeRequest('POST', '/api/surveys/themes/1/start', null, userToken);

        if (response.statusCode === 200) {
            console.log('‚úÖ D√©marrage sondage r√©ussi');
            console.log(`   ID tentative: ${response.body.attemptId}`);
            console.log(`   Th√®me: ${response.body.theme.name}`);
            console.log(`   Nombre de questions: ${response.body.totalQuestions}`);
            return response.body.attemptId;
        } else {
            console.log('‚ùå √âchec d√©marrage sondage:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur d√©marrage sondage:', error.message);
        return false;
    }
}

// Test 11: Param√®tres admin
async function testAdminSettings() {
    console.log('\n1Ô∏è‚É£1Ô∏è‚É£ Test param√®tres admin...');

    try {
        const response = await makeRequest('GET', '/api/admin/settings', null, adminToken);

        if (response.statusCode === 200) {
            console.log('‚úÖ Acc√®s param√®tres r√©ussi');
            console.log(`   Plateforme: ${response.body.settings?.platform?.name || 'N/A'}`);
            console.log(`   Version: ${response.body.settings?.platform?.version || 'N/A'}`);
            return true;
        } else {
            console.log('‚ùå √âchec acc√®s param√®tres:', response.statusCode, response.body);
            return false;
        }
    } catch (error) {
        console.log('‚ùå Erreur acc√®s param√®tres:', error.message);
        return false;
    }
}

// Ex√©cution de tous les tests
async function runAllTests() {
    console.log(`üìß Email de test: ${TEST_USER.email}\n`);
    
    const results = [];
    
    results.push(await testUserRegistration());
    results.push(await testUserLogin());
    results.push(await testUserProfile());
    results.push(await testAdminLogin());
    results.push(await testAdminStats());
    results.push(await testAdminUsers());
    results.push(await testUserApproval());
    results.push(await testUserReloginAfterApproval());
    results.push(await testSurveyThemes());
    results.push(await testStartSurvey());
    results.push(await testAdminSettings());
    
    // R√©sum√©
    const passed = results.filter(r => r).length;
    const total = results.length;
    
    console.log('\nüìä === R√âSUM√â DES TESTS ===');
    console.log(`‚úÖ Tests r√©ussis: ${passed}/${total}`);
    console.log(`‚ùå Tests √©chou√©s: ${total - passed}/${total}`);
    
    if (passed === total) {
        console.log('\nüéâ Tous les tests sont pass√©s ! L\'application fonctionne correctement.');
    } else {
        console.log('\n‚ö†Ô∏è  Certains tests ont √©chou√©. V√©rifiez les logs ci-dessus.');
    }
    
    console.log('\nüí° Prochaines √©tapes:');
    console.log('1. Testez l\'interface web manuellement');
    console.log('2. V√©rifiez les notifications dans l\'interface admin');
    console.log('3. Testez le cycle complet utilisateur ‚Üí admin ‚Üí approbation');
}

// Lancer tous les tests
runAllTests().catch(error => {
    console.error('‚ùå Erreur lors de l\'ex√©cution des tests:', error);
});
